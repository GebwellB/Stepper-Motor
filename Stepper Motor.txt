from machine import Pin
import utime
import network
import socket as socket
utime.sleep(0.1) # Wait for USB to become ready

# Connect to Wi-Fi
print("Connecting to WiFi...")
wifi = network.WLAN(network.STA_IF)
wifi.active(True)
wifi.connect('TestNetwork', 'SuperCrazyStrongPassword123$') 

# Print WiFi status to console
print('Connected to Wi-Fi:', wifi.ifconfig())
utime.sleep(1)

# Create UDP socket
udp_sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)

# Define destination IP address and port
dest_ip = '172.20.24.22' # Replace with your IP
dest_port = 12345  # # Replace with your UDP port

# Send UDP packet
# udp_sock.sendto(message, (dest_ip, dest_port))

# Changes motor direction to anti-clockwise
def move_motor_down():
  stepper_pins[0].value(0)
  stepper_pins[1].value(1)
  flash_lights()
  stepper_pins[1].value(0)

# Changes motor direction to clockwise
def move_motor_up():
  stepper_pins[0].value(1)
  stepper_pins[1].value(1)
  flash_lights()
  stepper_pins[1].value(0)

# Turns all lights off
def lights_off():
  light_pins[0].value(0)
  light_pins[1].value(0)

# Flashes lights while arm is moving
def flash_lights():
  light_pins[0].value(1)
  light_pins[1].value(0)
  utime.sleep(0.2)
  light_pins[0].value(0)
  light_pins[1].value(1)
  utime.sleep(0.2)

# def send_message(message)
  # udp_sock.sendto(message, (dest_ip, dest_port))

# Controls motor movement
def move_motor():
  gate_closed = False
  stepper_pins[1].value(1)
  for x in range (0,50):
    move_motor_down()
  lights_off()
  print("Waiting 60 seconds, but really it's 2 seconds")
  gate_closed = True
  # send_message("Gate closed")
  print(gate_closed)
  utime.sleep(2)
  gate_closed = False
  # send_message("Gate opened")
  print(gate_closed)
  for x in range (0,50):
    move_motor_up()
  lights_off()
  
# Define stepper pins
stepper_pins = [
  Pin(2, Pin.OUT),
  Pin(3, Pin.OUT),
]

# Define light pins
light_pins = [
  Pin(27, Pin.OUT),
  Pin(26, Pin.OUT),
]

# Button
BUTTON = Pin(6, Pin.IN, Pin.PULL_DOWN)

# Use loops to set pins in sequence
while True:
  print("Pending Button Press", BUTTON.value())
  if BUTTON.value() == 1:
    print("pressed")
    move_motor()
  utime.sleep(0.1)
